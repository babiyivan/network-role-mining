```{r message=FALSE, warning=FALSE}
library(dplyr)
library(tidyr)
library(forcats)
library(arrow)
library(igraph)
library(blockmodeling)
library(ggplot2)
library(svglite)
```

# Read graphs.

```{r}
types = c('replies', 'votes', 'follows')
gs = list()
n = 253
for (t in types) {
  gs[[t]] = read_graph(paste0('graphs/',t,'-',n,'.graphml'), format = 'graphml')
}
```

# Perform blockmodelling on the three graphs.

Takes a long time. Not necessary to run if .rds result files already available.

```{r}
for (appr in c('bin', 'val')) {
  bm = list()
  for (x in types) {
    M <- as_adjacency_matrix(gs[[x]], sparse = FALSE)
    results = list()
    for (k in 3:8) {
      res <- optRandomParC(M = M, k = k, rep = 1000,
          approach = appr, blocks = c('nul', 'com', 'reg'), nCores = 0)
      print(err(res))
      results[[k]] = res
    }
    saveRDS(results, file=paste0('results/bm/bm-', x, '-', n, '-', appr, '.rds'))
    bm[[x]] = results
  }
  saveRDS(bm, file=paste0('results/bm/bm-', n, '-', appr, '.rds'))
}
for (r in results){
  print(err(r))
}
```


# Results analysis

## Analyse groups found by blockmodelling.

Inspect permuted matrices

```{r}
# binary/unweighted blockmodelling results
res = list()
res[['replies']] = readRDS('results/bm/bm-replies-276.rds')
res[['votes']] = readRDS('results/bm/bm-votes-276.rds')
res[['follows']] = readRDS('results/bm/bm-follows-276.rds')

# valued/weighted blockmodelling results
res = readRDS('results/bm/bm-all-val.rds')
```

Print adjacency matrices

```{r}
for (x in types) {
  for (k in 3:8) {
    # png(paste('results/adjmat-',x,'-',k,'.png', sep=''), width = 800, height = 800)
    plot(res[[x]][[k]], main = paste('Permuted matrix for', x, 'with', k, 'groups'),
      mar = c(1, 2, 3, 1), title.line = 2)
    dens = funByBlocks(res[[x]][[k]])
    dens[is.nan(dens)] <- 0
    # plotMat(dens)
    # dev.off()
  }
}
```

Inspect number of regular equivalence inconsistencies over different numbers of groups.

```{r}
err_replies = sapply(res[['replies']], err)[3:8]
err_votes = sapply(res[['votes']], err)[3:8]
err_follows = sapply(res[['follows']], err)[3:8]

for (err in list(err_replies, err_votes, err_follows)) {
  p = ggplot(mapping =aes(x = 3:8, y = err)) +
    geom_line(color = 'red') +
    geom_point(color = 'red') +
    labs(
      title = 'Number of regular equivalence inconsistencies in empirical graph',
      x = 'Number of groups',
      y = 'Number of regular equivalence violations'
    ) +
    theme_minimal()
  print(p)
}
# export plots
# ggplot(mapping=aes(x = 3:8, y = err_follows)) +
#     geom_line(color = 'red') +
#     geom_point(color = 'red') +
#     labs(
#       title = 'Number of regular equivalence inconsistencies in empirical graph',
#       x = 'Number of groups',
#       y = 'Number of regular equivalence violations'
#     ) +
#     theme_minimal()
# ggsave('results/bm/incons-follows.svg')
```

## Inspect overall inconsistency rates in all 3 graphs

```{r}
errrate_replies = err_replies / ecount(g_replies)
errrate_votes = err_votes / ecount(g_votes)
errrate_follows = err_follows / ecount(g_follows)

errs <- data.frame(
  groups = rep(3:8, 3),
  error_rate = c(errrate_replies, errrate_votes, errrate_follows) ,
  type = rep(types, each = 6)
)

ggplot(errs, aes(x = groups, y = error_rate, color = type)) +
  geom_line() +
  geom_point() +
  labs(title = "Inconsistency Rates for Different Numbers of Groups/Roles",
       x = "Number of Groups",
       y = "Inconsistency Rate") +
  theme_minimal()

# ggsave(paste('results/incons-', n, '.svg', sep=''))
```

## Inspect relationship between groups

Build data frames with node membership info

```{r}
# set number of groups in each graph based on findings 
k = list(replies = 3, votes = 4, follows = 3)

groups = list(3)

for (type in types) {
  clus = data.frame(
    name = V(gs[[type]])$name,
    type = clu(res[[type]][[k[[type]]]])
  )
  names(clus) = c('name', paste('group_', type, sep=''))
  groups[[type]] = clus
}

```

Build graph of relationships between different equivalence classes

```{r}
group_rel = list(3)
for (type in types) {
  A = IM(res[[type]][[k[[type]]]])

  A[A == 'com'] <- 1
  A[A == 'reg'] <- 1
  A[A == 'nul'] <- 0
  
  A = matrix(as.numeric(A), nrow = nrow(A), ncol = ncol(A))
  
  g <- graph_from_adjacency_matrix(A, mode = "directed", weighted = FALSE)
  
  group_col = paste('group_', type, sep='')
  
  group_sizes = count(groups[[type]], !!sym((group_col)))
  
  # png(paste('results/bm/rel-', n, '-', type, '.png', sep=''))
  plot(g, layout = layout_with_fr(g, maxx=rep(400, vcount(g))),
       vertex.frame.width=0, vertex.color = V(g), vertex.size = group_sizes$n,vertex.label.color='black',
       edge.arrow.size = .5, loop.size = 1.5)
  # dev.off()
  group_rel[[type]] = g
}
```

## Inpsect combinations of group membership of nodes across replying, voting, following behaviours


```{r}
membership = groups[['replies']] %>%
  inner_join(groups[['votes']], by = 'name') %>%
  inner_join(groups[['follows']], by = 'name') %>%
  unite(group,contains('group_'), remove=FALSE)


group_freq <- membership %>%
  count(group)

# Plot the frequency distribution of the values in the 'group' column, sorted by frequency
ggplot(group_freq, aes(x = fct_reorder(group, n, .desc = TRUE), y = n)) +
  geom_bar(stat = 'identity') +
  labs(
    title = 'Frequency Distribution of Group Values',
    x = 'Group',
    y = 'Frequency'
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

## Inspect network properties by group

```{r}
k = list(replies = 3, votes = 4, follows = 3)

groups = list(3)


for (type in types) {
  clus = data.frame(
    name = V(gs[[type]])$name,
    type = clu(res[[type]][[k[[type]]]])
  )
  names(clus) = c('name', paste('group_', type, sep=''))
  clus = clus %>%
    mutate(
      indegree = degree(gs[[type]], mode = 'in'),
      outdegree = degree(gs[[type]], mode = 'out'),
      betweenness = betweenness(gs[[type]]),
      eigen = eigen_centrality(gs[[type]])$vector
    )
  # add group membership to graph objects
  gs[[type]]$group = clu(res[[type]][[k[[type]]]])
  groups[[type]] = clus
}


for (type in types) {
  x = paste('group_', type, sep='')
  for (col in c('indegree', 'outdegree', 'betweenness', 'eigen')) {
    p = ggplot(groups[[type]], aes(x = as.factor(.data[[x]]), y = .data[[col]])) +
      geom_boxplot() +
      labs(
        title = paste('Boxplot of', col, 'by group in', type, 'graph'),
        x = 'Group',
        y = col
      ) +
      theme_minimal() +
      theme(axis.text.x = element_text(angle = 90, hjust = 1))
    print(p)
    # ggsave(paste('results/bm/', type, '-', n, '-', col, '.svg', sep=''))
  }
}

```




